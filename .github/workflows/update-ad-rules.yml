name: Update AdGuard Rules

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  update-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install pyyaml requests
        
      # ğŸ” ã€å¿…åŠ ã€‘ç²¾å‡†éªŒè¯è„šæœ¬æ˜¯å¦å­˜åœ¨ï¼ˆé¿å…è·¯å¾„çŒœæµ‹ï¼‰
      - name: ğŸ” Verify Script Path
        run: |
          SCRIPT="${{ github.workspace }}/Files/py/update_ad_rules.py"
          echo "ğŸ” æ£€æŸ¥è„šæœ¬è·¯å¾„: $SCRIPT"
          if [ -f "$SCRIPT" ]; then
            echo "âœ… è„šæœ¬å­˜åœ¨! è¡Œæ•°: $(wc -l < "$SCRIPT") | å¤§å°: $(wc -c < "$SCRIPT") å­—èŠ‚"
            echo "ğŸ“Œ è„šæœ¬å‰3è¡Œé¢„è§ˆ:"
            head -3 "$SCRIPT"
          else
            echo "âŒ è„šæœ¬ä¸å­˜åœ¨! ä»“åº“ç»“æ„:"
            find "${{ github.workspace }}" -type f -name "update_ad_rules.py" 2>/dev/null | head -5 || ls -R "${{ github.workspace }}" | grep -E "(py|Files)" | head -10
            exit 1
          fi

      # ğŸš€ ã€å…³é”®ã€‘ä¿®æ­£åçš„è„šæœ¬è°ƒç”¨ï¼ˆæ— ç©ºæ ¼ã€è¯­æ³•æ­£ç¡®ï¼‰
      - name: Update rules file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: Star7-Files-Hub
          REPO_NAME: Files
          RULES_PATH: Files/Ad/AdGuardHomeBlack.txt
        run: python "${{ github.workspace }}/Files/py/update_ad_rules.py"  # æ— ç©ºæ ¼ï¼æ— å¤šä½™å­—ç¬¦ï¼

      # ğŸ’¾ ä¼˜åŒ– Commit æ­¥éª¤ï¼ˆé˜²ç©ºæäº¤+æ˜ç¡®è·¯å¾„ï¼‰
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Files/Ad/AdGuardHomeBlack.txt"
          if git diff --cached --quiet; then
            echo "â­ï¸ æ— å†…å®¹å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°è§„åˆ™ | $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
